#' @title convertGTAP
#' @description Converts GTAP data to fit to the common country list. Weighting is done by using the Imports and
#' Exports from FAO
#'
#' @param x MAgPIE object contains GTAP data
#' @param subtype The GTAP subtype: VIWS, VIMS VXWD, VXMD, VOA, VOM
#' @return Converted GTAP Data
#' @author Xiaoxi Wang
#' @examples
#' \dontrun{
#' x <- ReadSource("GTAP", "GTAP7_VIMS")
#' }
#' @importFrom madrat toolAggregate
#' @importFrom magclass as.magpie magpiesort

convertGTAP <- function(x, subtype) {
  x <- magpiesort(x)

  gtap <- paste0(gsub("(?<=\\d)\\w{1,}", "", subtype, perl = TRUE))
  subtype <- unlist(strsplit(subtype, "_"))[[2]]

  fao <- collapseNames(calcOutput("FAOmassbalance", aggregate = FALSE)[, 2005, "dm"])

  if (gtap == "GTAP7") {
    regMapping <- toolGetMapping(type = "regional", name = "GTAP7Mapping2016.csv", where = "mrland")
  } else if (gtap == "GTAP8") {
    regMapping <- toolGetMapping(type = "regional", name = "GTAP8Mapping2016.csv", where = "mrland")
  }

  sectorMapping <- toolGetMapping(type = "sectoral", name = "mappingGTAPMAgPIETrade.csv", where = "mrland")
  sectorMapping <- sectorMapping[which(sectorMapping$gtap != "xxx" & sectorMapping$magpie != "zzz"), ]

  if (subtype %in% c("VIWS", "VIMS", "VXWD", "VXMD")) {
    faoImport <- collapseNames(fao[, 2005, "import"])
    faoExport <- collapseNames(fao[, 2005, "export"])
    if (subtype %in% c("VXWD", "VXMD")) {
      w1 <- toolAggregate(faoExport, rel = regMapping, from = "Country.code", to = "Region.code",
                          dim = 1, partrel = TRUE)
      w1 <- toolAggregate(w1, rel = sectorMapping, from = "magpie", to = "gtap", dim = 3, partrel = TRUE)

      w2 <- toolAggregate(faoImport, rel = regMapping, from = "Country.code", to = "Region.code",
                          dim = 1, partrel = TRUE)
      w2 <- toolAggregate(w2, rel = sectorMapping, from = "magpie", to = "gtap", dim = 3, partrel = TRUE)

      w3 <- toolAggregate(faoExport, rel = sectorMapping, from = "magpie", to = "gtap", dim = 3, partrel = TRUE)

      out <- toolAggregate(x[, , getNames(w1)], rel = regMapping, from = "Region.code", to = "Country.code",
                           dim = 1, weight = w1)
      out <- as.magpie(aperm(unwrap(out), c(3, 2, 1, 4)), spatial = 1, temporal = 2)
      out <- toolAggregate(out[, , getNames(w2)], rel = regMapping, from = "Region.code", to = "Country.code",
                           dim = 1, weight = w2)
      out <- as.magpie(aperm(unwrap(out), c(3, 2, 1, 4)), spatial = 1, temporal = 2)
      out <- toolAggregate(out, rel = sectorMapping, from = "gtap", to = "magpie", dim = 3.2,
                           weight = w3[getItems(out, dim = 1.1), , ], partrel = TRUE)
    } else if (subtype %in% c("VIWS", "VIMS")) {
      w1 <- toolAggregate(faoImport, rel = regMapping, from = "Country.code", to = "Region.code",
                          dim = 1, partrel = TRUE)
      w1 <- toolAggregate(w1, rel = sectorMapping, from = "magpie", to = "gtap", dim = 3, partrel = TRUE)

      w2 <- toolAggregate(faoExport, rel = regMapping, from = "Country.code", to = "Region.code",
                          dim = 1, partrel = TRUE)
      w2 <- toolAggregate(w2, rel = sectorMapping, from = "magpie", to = "gtap", dim = 3, partrel = TRUE)

      w3 <- toolAggregate(faoImport, rel = sectorMapping, from = "magpie", to = "gtap", dim = 3, partrel = TRUE)

      out <- toolAggregate(x[, , getNames(w1)], rel = regMapping, from = "Region.code", to = "Country.code",
                           dim = 1, weight = w1)
      out <- as.magpie(aperm(unwrap(out), c(3, 2, 1, 4)), spatial = 1, temporal = 2)
      out <- toolAggregate(out[, , getNames(w2)], rel = regMapping, from = "Region.code", to = "Country.code",
                           dim = 1, weight = w2)
      out <- as.magpie(aperm(unwrap(out), c(3, 2, 1, 4)), spatial = 1, temporal = 2)
      out <- toolAggregate(out, rel = sectorMapping, from = "gtap", to = "magpie", dim = 3.2,
                           weight = w3[getItems(out, dim = 1.1), , ], partrel = TRUE)
    }
  } else if (subtype %in% c("VOM", "VOA")) {
    faoProduction <- collapseNames(fao[, , "production"])
    w1 <- toolAggregate(faoProduction, rel = regMapping, from = "Country.code", to = "Region.code",
                        dim = 1, partrel = TRUE)
    w1 <- toolAggregate(w1, rel = sectorMapping, from = "magpie", to = "gtap", dim = 3, partrel = TRUE)

    w2 <- toolAggregate(faoProduction, rel = sectorMapping, from = "magpie", to = "gtap", dim = 3, partrel = TRUE)

    out <- toolAggregate(x[, , getNames(w1)], rel = regMapping, from = "Region.code", to = "Country.code",
                         dim = 1, weight = w1)
    out <- toolAggregate(out, rel = sectorMapping, from = "gtap", to = "magpie", dim = 3,
                         weight = w2[getItems(out, dim = 1.1), , ], partrel = TRUE)
  } else {
    (stop("Not supported by current convertGTAP funtion, please set convert to FALSE!"))
  }
  out <- toolCountryFill(out, 0)

  return(out)
}
