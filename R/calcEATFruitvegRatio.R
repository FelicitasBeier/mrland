#' @title calcEATFruitvegRatio
#' @description
#' Calculates the share of fruits and vegetables in the calorie supply from the others MAgPIE commodity for the past.
#' Information on the calorie supply from fruits and vegetables is relevant in the context of dietary recommendations,
#' e.g. as proposed by the EAT-Lancet Commission on healthy diets from sustainable food systems.
#'
#' @param populationweight datasource of populationweight: FAO can be selected in order to better meet exact values.
#' Normal datasource is PopulationPast
#' @return List of magpie objects with results on country level, weight on country level, unit and description.
#' @author Isabelle Weindl
#' @seealso \code{\link{calcOutput}}, \code{\link{calcEATLancetTargets}}, \code{\link{calcFAOharmonized}},
#' \code{\link{calcEATLancetDiets}}
#' @examples
#' \dontrun{
#' calcOutput("EATFruitvegRatio")
#' }
#' @importFrom madrat toolFillWithRegionAvg
#' @export

calcEATFruitvegRatio <- function(populationweight = "PopulationPast") {
  ### FAO Commodity balance
  FAOcbs  <- calcOutput(type = "FAOharmonized", aggregate = FALSE)[, , "food_supply_kcal"]
  pastYrs <- findset("past")
  FAOcbs  <- collapseNames(FAOcbs[, pastYrs, ])
  getSets(FAOcbs) <- c("region", "year", "ItemCodeItem")

  ### Population weight
  if (populationweight == "PopulationPast") {
    weight <- collapseNames(calcOutput("PopulationPast", aggregate = FALSE))
  } else if (populationweight == "FAO") {
    weight <- collapseNames(readSource(type = "FAO", subtype = "Pop",
                                       convert = TRUE)[, , "population"]) / 1e+6
  }
  weight <- weight[, pastYrs, ]

  ### Sectoral mapping for FAO items
  relationmatrix <- toolGetMapping("FAOitems.csv", type = "sectoral", where = "mappingfolder")
  relationmatrix <- relationmatrix[, c("FoodBalanceItem", "k")]
  relationmatrix <- relationmatrix[!duplicated(relationmatrix[, "FoodBalanceItem"]), ]

  ### Definitions of the food groups "others" and "fruitvegOthers"
  ### (all fruits and vegetables contained in "others")
  others <- relationmatrix[relationmatrix$k %in% "others", "FoodBalanceItem"]
  fruitvegOthers <- c("2601|Tomatoes and products",
                  "2602|Onions",
                  "2605|Vegetables, Other",
                  "2611|Oranges, Mandarines",
                  "2612|Lemons, Limes and products",
                  "2613|Grapefruit and products",
                  "2614|Citrus, Other",
                  "2617|Apples and products",
                  "2618|Pineapples and products",
                  "2619|Dates",
                  "2620|Grapes and products (excl wine)",
                  "2625|Fruits, Other")
  # Note: In FAOitems.csv 2615|Bananas and 2616|Plantains are mapped to the magpie commodity "cassav_sp".

  # check if all fruits and vegetables included in "fruitvegOthers" are also contained in "others":
  if (any(setdiff(fruitvegOthers, others)) == TRUE) {
    stop("The above definition of fruits and vegetables (fruitvegOthers)
         is not consistent with the current mapping of FAO items to MAgPIE commodities.")
  }

  ### Aggregation of calories and calculation of ratios:
  kcalOthers <- dimSums(FAOcbs[, , others], dim = 3)
  kcalFrutiVeg <- dimSums(FAOcbs[, , fruitvegOthers], dim = 3)

  ratioFruitveg2Others <- kcalFrutiVeg / kcalOthers
  out <- toolFillWithRegionAvg(ratioFruitveg2Others, weight = weight, verbose = FALSE)

  min <- 0

  return(list(x = out,
              weight = weight,
              unit = "-",
              description = "share of fruits and vegetables in the others food group",
              min = min))
}
